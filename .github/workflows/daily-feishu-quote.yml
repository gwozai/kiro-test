name: Daily Feishu Quote

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼Œæ‰€ä»¥ UTC æ˜¯ 0 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send-quote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick random quote and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # ä»æ‰€æœ‰ page æ–‡ä»¶ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
          PAGE_FILE=$(ls crawled_data/page_*.json | shuf -n 1)
          echo "Selected file: $PAGE_FILE"
          
          # ä»è¯¥æ–‡ä»¶çš„ articles ä¸­éšæœºæŠ½å–ä¸€æ¡ title
          QUOTE=$(jq -r '.articles | map(.title) | unique | .[]' "$PAGE_FILE" | shuf -n 1)
          echo "Selected quote: $QUOTE"
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="ğŸ“ æ¯æ—¥ä¸€å¥ ($DATE)\n\n$QUOTE"
          
          # å‘é€åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
            "$FEISHU_WEBHOOK"

      - name: Fetch random image from API and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # éšæœºé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡ç±»å‹
          TYPES=("horizontal" "ai_yes" "normal" "r18_0" "r18_1" "r18_vertical" "vertical")
          TYPE=${TYPES[$RANDOM % ${#TYPES[@]}]}
          
          # æ ¹æ®ç±»å‹è®¾ç½® API å‚æ•°
          case $TYPE in
            "horizontal") PARAMS="imageSizeType=1" ;;
            "ai_yes") PARAMS="aiType=2" ;;
            "normal") PARAMS="" ;;
            "r18_0") PARAMS="r18Type=0" ;;
            "r18_1") PARAMS="r18Type=1" ;;
            "r18_vertical") PARAMS="r18Type=1&imageSizeType=2" ;;
            "vertical") PARAMS="imageSizeType=2" ;;
          esac
          
          echo "Selected type: $TYPE"
          
          # ä» Mossia API è·å–å›¾ç‰‡
          API_URL="https://api.mossia.top/duckMo?num=1&${PARAMS}"
          echo "API URL: $API_URL"
          
          RESP=$(curl -s "$API_URL")
          echo "API Response: $RESP"
          
          # è§£æå“åº”
          SUCCESS=$(echo "$RESP" | jq -r '.success')
          
          if [ "$SUCCESS" = "true" ]; then
            IMAGE_URL=$(echo "$RESP" | jq -r '.data[0].urlsList[0].url // empty')
            PID=$(echo "$RESP" | jq -r '.data[0].pid // "unknown"')
            TITLE=$(echo "$RESP" | jq -r '.data[0].title // "æ— æ ‡é¢˜"' | head -c 50)
            AUTHOR=$(echo "$RESP" | jq -r '.data[0].author // "æœªçŸ¥"')
            
            if [ -n "$IMAGE_URL" ]; then
              echo "Image URL: $IMAGE_URL"
              
              # è·å–å½“å‰æ—¥æœŸ
              DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
              
              # å‘é€å¯Œæ–‡æœ¬æ¶ˆæ¯åˆ°é£ä¹¦ï¼ˆåŒ…å«å›¾ç‰‡é“¾æ¥ï¼‰
              MESSAGE="ğŸ–¼ï¸ æ¯æ—¥ä¸€å›¾ ($DATE)\n\nğŸ“Œ ç±»å‹: $TYPE\nğŸ¨ ä½œè€…: $AUTHOR\nğŸ“ æ ‡é¢˜: $TITLE\nğŸ”— PID: $PID\n\nğŸŒ å›¾ç‰‡é“¾æ¥:\n$IMAGE_URL"
              
              curl -X POST \
                -H "Content-Type: application/json" \
                -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
                "$FEISHU_WEBHOOK"
              
              echo "Message sent successfully!"
            else
              echo "No image URL in response"
            fi
          else
            echo "API request failed"
            MESSAGE=$(echo "$RESP" | jq -r '.message // "æœªçŸ¥é”™è¯¯"')
            echo "Error: $MESSAGE"
          fi
