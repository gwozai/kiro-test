name: Daily Feishu Quote

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼Œæ‰€ä»¥ UTC æ˜¯ 0 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send-quote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick random quote and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # ä»æ‰€æœ‰ page æ–‡ä»¶ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
          PAGE_FILE=$(ls crawled_data/page_*.json | shuf -n 1)
          echo "Selected file: $PAGE_FILE"
          
          # ä»è¯¥æ–‡ä»¶çš„ articles ä¸­éšæœºæŠ½å–ä¸€æ¡ title
          QUOTE=$(jq -r '.articles | map(.title) | unique | .[]' "$PAGE_FILE" | shuf -n 1)
          echo "Selected quote: $QUOTE"
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="ğŸ“ æ¯æ—¥ä¸€å¥ ($DATE)\n\n$QUOTE"
          
          # å‘é€åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
            "$FEISHU_WEBHOOK"

      - name: Pick random image and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
          IMAGE_FILE=$(ls daily_images/*.{jpg,png} 2>/dev/null | shuf -n 1)
          
          if [ -z "$IMAGE_FILE" ]; then
            echo "No images found"
            exit 0
          fi
          
          echo "Selected image: $IMAGE_FILE"
          FILENAME=$(basename "$IMAGE_FILE")
          
          # è§£æå›¾ç‰‡ç±»å‹
          TYPE=$(echo "$FILENAME" | sed 's/_[0-9]*\..*//')
          
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          
          # ä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠè·å–URL (ä½¿ç”¨ sm.ms)
          UPLOAD_RESP=$(curl -s -X POST \
            -F "smfile=@$IMAGE_FILE" \
            "https://sm.ms/api/v2/upload")
          
          IMAGE_URL=$(echo "$UPLOAD_RESP" | jq -r '.data.url // .images')
          
          if [ -n "$IMAGE_URL" ] && [ "$IMAGE_URL" != "null" ]; then
            echo "Image URL: $IMAGE_URL"
            
            # å‘é€å›¾ç‰‡å¡ç‰‡åˆ°é£ä¹¦
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{
                \"msg_type\": \"interactive\",
                \"card\": {
                  \"header\": {
                    \"title\": {\"tag\": \"plain_text\", \"content\": \"ğŸ–¼ï¸ æ¯æ—¥ä¸€å›¾ ($DATE)\"},
                    \"template\": \"blue\"
                  },
                  \"elements\": [
                    {\"tag\": \"img\", \"img_key\": \"$IMAGE_URL\", \"alt\": {\"tag\": \"plain_text\", \"content\": \"$FILENAME\"}},
                    {\"tag\": \"div\", \"text\": {\"tag\": \"plain_text\", \"content\": \"ç±»å‹: $TYPE\"}}
                  ]
                }
              }" \
              "$FEISHU_WEBHOOK"
          else
            # å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œå‘é€æ–‡æœ¬é€šçŸ¥
            MESSAGE="ğŸ–¼ï¸ æ¯æ—¥ä¸€å›¾ ($DATE)\n\næ–‡ä»¶: $FILENAME\nç±»å‹: $TYPE\n\n(å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä»“åº“)"
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
              "$FEISHU_WEBHOOK"
          fi
