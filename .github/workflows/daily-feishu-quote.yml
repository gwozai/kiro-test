name: Daily Feishu Quote

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼Œæ‰€ä»¥ UTC æ˜¯ 0 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send-quote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick random quote and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # ä»æ‰€æœ‰ page æ–‡ä»¶ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
          PAGE_FILE=$(ls crawled_data/page_*.json | shuf -n 1)
          echo "Selected file: $PAGE_FILE"
          
          # ä»è¯¥æ–‡ä»¶çš„ articles ä¸­éšæœºæŠ½å–ä¸€æ¡ title
          QUOTE=$(jq -r '.articles | map(.title) | unique | .[]' "$PAGE_FILE" | shuf -n 1)
          echo "Selected quote: $QUOTE"
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="ğŸ“ æ¯æ—¥ä¸€å¥ ($DATE)\n\n$QUOTE"
          
          # å‘é€åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
            "$FEISHU_WEBHOOK"
