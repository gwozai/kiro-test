name: Daily Feishu Quote

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼Œæ‰€ä»¥ UTC æ˜¯ 0 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send-quote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick random quote and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # ä»æ‰€æœ‰ page æ–‡ä»¶ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
          PAGE_FILE=$(ls crawled_data/page_*.json | shuf -n 1)
          echo "Selected file: $PAGE_FILE"
          
          # ä»è¯¥æ–‡ä»¶çš„ articles ä¸­éšæœºæŠ½å–ä¸€æ¡ title
          QUOTE=$(jq -r '.articles | map(.title) | unique | .[]' "$PAGE_FILE" | shuf -n 1)
          echo "Selected quote: $QUOTE"
          
          # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="ğŸ“ æ¯æ—¥ä¸€å¥ ($DATE)\n\n$QUOTE"
          
          # å‘é€åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}" \
            "$FEISHU_WEBHOOK"

      - name: Fetch random image from API and send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # éšæœºé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡ç±»å‹
          TYPES=("horizontal" "ai_yes" "normal" "r18_0" "r18_1" "r18_vertical" "vertical")
          TYPE=${TYPES[$RANDOM % ${#TYPES[@]}]}
          
          # æ ¹æ®ç±»å‹è®¾ç½® API å‚æ•°
          case $TYPE in
            "horizontal") PARAMS="imageSizeType=1" ;;
            "ai_yes") PARAMS="aiType=2" ;;
            "normal") PARAMS="" ;;
            "r18_0") PARAMS="r18Type=0" ;;
            "r18_1") PARAMS="r18Type=1" ;;
            "r18_vertical") PARAMS="r18Type=1&imageSizeType=2" ;;
            "vertical") PARAMS="imageSizeType=2" ;;
          esac
          
          echo "Selected type: $TYPE"
          
          # ä» Mossia API è·å–å›¾ç‰‡
          API_URL="https://api.mossia.top/duckMo?num=1&${PARAMS}"
          echo "API URL: $API_URL"
          
          RESP=$(curl -s "$API_URL")
          echo "API Response: $RESP"
          
          # è§£æå“åº”
          SUCCESS=$(echo "$RESP" | jq -r '.success')
          
          if [ "$SUCCESS" = "true" ]; then
            IMAGE_URL=$(echo "$RESP" | jq -r '.data[0].urlsList[0].url // empty')
            PID=$(echo "$RESP" | jq -r '.data[0].pid // "unknown"')
            TITLE=$(echo "$RESP" | jq -r '.data[0].title // "æ— æ ‡é¢˜"' | cut -c1-50)
            AUTHOR=$(echo "$RESP" | jq -r '.data[0].author // "æœªçŸ¥"')
            
            if [ -n "$IMAGE_URL" ]; then
              echo "Image URL: $IMAGE_URL"
              
              # ä¸‹è½½å›¾ç‰‡
              TEMP_IMG="/tmp/daily_image.jpg"
              curl -s -L -o "$TEMP_IMG" \
                -H "User-Agent: Mozilla/5.0" \
                -H "Referer: https://www.pixiv.net/" \
                "$IMAGE_URL"
              
              if [ -f "$TEMP_IMG" ] && [ -s "$TEMP_IMG" ]; then
                echo "Image downloaded, size: $(stat -c%s "$TEMP_IMG" 2>/dev/null || stat -f%z "$TEMP_IMG") bytes"
                
                # ä¸Šä¼ åˆ° imgbb å›¾åºŠ (å…è´¹ï¼Œæ”¯æŒç›´æ¥é“¾æ¥)
                UPLOAD_RESP=$(curl -s -X POST \
                  -F "image=@$TEMP_IMG" \
                  "https://api.imgbb.com/1/upload?key=7a1c3e3e3e3e3e3e3e3e3e3e3e3e3e3e")
                
                IMGBB_URL=$(echo "$UPLOAD_RESP" | jq -r '.data.url // empty')
                
                # å¦‚æœ imgbb å¤±è´¥ï¼Œå°è¯• sm.ms
                if [ -z "$IMGBB_URL" ] || [ "$IMGBB_URL" = "null" ]; then
                  echo "imgbb failed, trying sm.ms..."
                  UPLOAD_RESP=$(curl -s -X POST -F "smfile=@$TEMP_IMG" "https://sm.ms/api/v2/upload")
                  IMGBB_URL=$(echo "$UPLOAD_RESP" | jq -r '.data.url // .images // empty')
                fi
                
                rm -f "$TEMP_IMG"
                
                # è·å–å½“å‰æ—¥æœŸ
                DATE=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
                
                # æ„å»º Pixiv é“¾æ¥
                PIXIV_URL="https://www.pixiv.net/artworks/$PID"
                
                # ç¡®å®šæœ€ç»ˆå›¾ç‰‡URL
                FINAL_URL="${IMGBB_URL:-$IMAGE_URL}"
                
                # å‘é€å¡ç‰‡æ¶ˆæ¯
                curl -X POST \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"msg_type\": \"interactive\",
                    \"card\": {
                      \"header\": {
                        \"title\": {\"tag\": \"plain_text\", \"content\": \"ğŸ–¼ï¸ æ¯æ—¥ä¸€å›¾\"},
                        \"template\": \"blue\"
                      },
                      \"elements\": [
                        {
                          \"tag\": \"div\",
                          \"text\": {\"tag\": \"lark_md\", \"content\": \"**ğŸ“… æ—¶é—´:** $DATE\\n**ğŸ“Œ ç±»å‹:** $TYPE\\n**ğŸ¨ ä½œè€…:** $AUTHOR\\n**ğŸ“ æ ‡é¢˜:** $TITLE\"}
                        },
                        {\"tag\": \"hr\"},
                        {
                          \"tag\": \"action\",
                          \"actions\": [
                            {
                              \"tag\": \"button\",
                              \"text\": {\"tag\": \"plain_text\", \"content\": \"ğŸ–¼ï¸ æŸ¥çœ‹å›¾ç‰‡\"},
                              \"type\": \"primary\",
                              \"url\": \"$FINAL_URL\"
                            },
                            {
                              \"tag\": \"button\",
                              \"text\": {\"tag\": \"plain_text\", \"content\": \"ğŸ”— Pixiv åŸå›¾\"},
                              \"type\": \"default\",
                              \"url\": \"$PIXIV_URL\"
                            }
                          ]
                        }
                      ]
                    }
                  }" \
                  "$FEISHU_WEBHOOK"
                
                echo "Card message sent successfully!"
              else
                echo "Failed to download image"
              fi
            else
              echo "No image URL in response"
            fi
          else
            echo "API request failed"
          fi
